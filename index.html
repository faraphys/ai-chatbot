<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Physikus</title>

<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --ink:#0a2a43;
  --muted:#5b6a78;
  --accent:#2b8cff;
  --bubbleMe:#eef6ff;
  --bubbleBot:#f7fbf7;
  --stroke:rgba(0,0,0,.10);
  --shadow:0 10px 28px rgba(0,0,0,.10);
  --radius:16px;
}

html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--ink);
}

.wrap{
  height:100vh;
  display:flex;
  flex-direction:column;
}

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 12px;
  background:var(--card);
  border-bottom:1px solid var(--stroke);
}

.btn{
  border:1px solid var(--stroke);
  background:#fff;
  border-radius:12px;
  padding:8px 10px;
  cursor:pointer;
}

.panel{
  flex:1;
  display:flex;
  flex-direction:column;
  padding:10px 12px;
  gap:10px;
  min-height:0;
}

.chat{
  flex:1;
  background:var(--card);
  border:1px solid var(--stroke);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:10px;
  overflow:auto;
}

.msg{margin:10px 0}
.who{
  font-weight:700;
  font-size:12px;
  color:var(--muted);
  margin-bottom:4px;
}

.bubble{
  display:inline-block;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.06);
  white-space:pre-wrap;
  line-height:1.35;
  max-width:980px;
}

.me .bubble{background:var(--bubbleMe)}
.bot .bubble{background:var(--bubbleBot)}

.composer{display:flex;gap:10px}

textarea.input{
  flex:1;
  border:1px solid var(--stroke);
  border-radius:14px;
  padding:10px;
  resize:none;
  font-size:16px;
  min-height:44px;
  line-height:1.35;
}

.send{
  border:none;
  background:var(--accent);
  color:white;
  border-radius:14px;
  padding:10px 14px;
  cursor:pointer;
}

.send:disabled{opacity:.65}

/* ---------- Thinking indicator (no jitter, no tall box) ---------- */
/* Make the "thinking" bubble visually lighter and same line-height as others */
.bubble.thinking{
  padding:10px 12px;          /* same as normal bubble */
  opacity:0.85;
}

/* Reserve fixed width for the dots so the bubble width does NOT change */
.dotsSlot{
  display:inline-block;
  width:3ch;                  /* reserve space for "..." */
  text-align:left;
  vertical-align:baseline;
}

/* Animate dots inside a fixed-width slot (no layout change) */
.dotsSlot::before{
  content:"";
  animation:dots 1.2s steps(4,end) infinite;
}

/* Slower after 5s */
.dotsSlot.slow::before{
  animation-duration:2.2s;
}

@keyframes dots{
  0%{content:""}
  25%{content:"."}
  50%{content:".."}
  75%{content:"..."}
}
</style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div><b>Physikus</b></div>
    <button id="reset" class="btn">Zurücksetzen</button>
  </div>

  <div class="panel">
    <div id="chat" class="chat" aria-live="polite"></div>

    <div class="composer">
      <textarea id="q" class="input" placeholder="Frage stellen…"></textarea>
      <button id="send" class="send">Senden</button>
    </div>

    <div style="font-size:12px;color:var(--muted)">
      Enter = Senden · Shift+Enter = neue Zeile
    </div>
  </div>

</div>

<script>
const WORKER_URL="https://ai-chat-app.raphaerber.workers.dev/api/chat";

const chatEl=document.getElementById("chat");
const qEl=document.getElementById("q");
const sendEl=document.getElementById("send");
const resetEl=document.getElementById("reset");

let messages=[];

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

function addMsg(role,who,text,opts={}){
  const div=document.createElement("div");
  div.className="msg "+(role==="user"?"me":"bot");

  const bubbleClass = opts.thinking ? "bubble thinking" : "bubble";

  div.innerHTML=
    `<div class="who">${escapeHtml(who)}</div>`+
    `<div class="${bubbleClass}">${escapeHtml(text)}</div>`;

  chatEl.appendChild(div);
  chatEl.scrollTop=chatEl.scrollHeight;
  return div;
}

function boot(){
  messages=[];
  chatEl.innerHTML="";
  const hello="Hallo! Ich bin Physikus.";
  addMsg("assistant","Physikus",hello);
  messages.push({role:"assistant",content:hello});
  qEl.value="";
  qEl.focus();
}

async function ask(){
  const text=qEl.value.trim();
  if(!text) return;

  qEl.value="";
  addMsg("user","Du",text);
  messages.push({role:"user",content:text});

  const payload={messages:messages.slice(-12)};
  sendEl.disabled=true;

  let thinkingMsgDiv=null;
  let dotsEl=null;

  // Only show thinking after 500ms to avoid flicker
  const thinkingTimer=setTimeout(()=>{
    thinkingMsgDiv=document.createElement("div");
    thinkingMsgDiv.className="msg bot";
    thinkingMsgDiv.innerHTML = `
      <div class="who">Physikus</div>
      <div class="bubble thinking">
        ⏳ Ich überlege kurz<span class="dotsSlot"></span>
      </div>
    `;
    chatEl.appendChild(thinkingMsgDiv);
    chatEl.scrollTop=chatEl.scrollHeight;

    dotsEl = thinkingMsgDiv.querySelector(".dotsSlot");

    // Slow dots after 5s (if still waiting)
    setTimeout(()=>{
      if(dotsEl) dotsEl.classList.add("slow");
    },5000);

  },500);

  try{
    const res=await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });

    const data=await res.json();
    const reply=(data && data.reply) ? data.reply : "Keine Antwort erhalten.";

    clearTimeout(thinkingTimer);
    if(thinkingMsgDiv) thinkingMsgDiv.remove();

    addMsg("assistant","Physikus",reply);
    messages.push({role:"assistant",content:reply});

  }catch{
    clearTimeout(thinkingTimer);
    if(thinkingMsgDiv) thinkingMsgDiv.remove();
    addMsg("assistant","Physikus","Fehler beim Verbinden.");
  }finally{
    sendEl.disabled=false;
    qEl.focus();
  }
}

// Enter = send, Shift+Enter = newline
qEl.addEventListener("keydown",(e)=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    ask();
  }
});

sendEl.addEventListener("click",ask);
resetEl.addEventListener("click",boot);
window.addEventListener("load",boot);
</script>

</body>
</html>
