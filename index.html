<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Physikus</title>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

<style>
:root{
  --bg:#f4f6fb;              /* page background */
  --card:#ffffff;            /* card */
  --ink:#0a2a43;
  --muted:#5b6a78;
  --accent:#2b8cff;          /* title bar blue */
  --chatbg:#eef2f7;          /* grey chat area background */
  --bubbleMe:#eef6ff;
  --bubbleBot:#f7fbf7;
  --stroke:rgba(0,0,0,.10);
  --shadow:0 10px 28px rgba(0,0,0,.10);
  --radius:16px;
}

html,body{height:100%; margin:0;}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--ink);
}

/* Full-height app */
.wrap{
  height:100vh;
  display:flex;
  flex-direction:column;
  padding:10px 12px;
  box-sizing:border-box;
  min-height:0;
}

/* Chat card */
.chat{
  flex:1;
  min-height:0;
  background:var(--card);
  border:1px solid var(--stroke);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  overflow:hidden;

  display:flex;
  flex-direction:column;
}

/* ===== Single blue title bar (no extra white strip) ===== */
.titlebar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:8px 10px;
  background:var(--accent);
  color:#fff;
}

.titleLeft{
  display:flex;
  align-items:center;
  gap:8px;
  font-weight:800;
  letter-spacing:.2px;
}

.titleLeft .tag{
  font-weight:600;
  opacity:.9;
  font-size:12px;
}

.titleActions{
  display:flex;
  align-items:center;
  gap:8px;
}

.resetBtn{
  height:34px;
  padding:0 10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.35);
  background:rgba(255,255,255,.14);
  color:#fff;
  cursor:pointer;
  font-size:13px;
  font-weight:700;

  display:flex;
  align-items:center;
  gap:8px;
  user-select:none;
}
.resetBtn:hover{
  background:rgba(255,255,255,.22);
}

/* Scroll area of chat messages */
.chatBody{
  flex:1;
  min-height:0;
  overflow:auto;
  padding:10px;
  background:var(--chatbg);
}

/* Message bubbles */
.msg{margin:10px 0;}
.who{
  font-weight:800;
  font-size:11px;
  color:var(--muted);
  margin-bottom:4px;
}

.bubble{
  position:relative;
  display:inline-block;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.06);
  white-space:pre-wrap;
  line-height:1.35;
  font-size:14px;
  max-width:900px;
  background:#fff;
}

.me .bubble{ background:var(--bubbleMe); }
.bot .bubble{ background:var(--bubbleBot); }

/* Footer (composer + hint) stays visible */
.footer{
  border-top:1px solid var(--stroke);
  background:var(--card);
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.composer{
  display:flex;
  gap:10px;
  align-items:stretch;
}

textarea.input{
  flex:1;
  background:#fff;
  border:1px solid var(--stroke);
  border-radius:14px;
  padding:10px 12px;
  font-size:14px;
  outline:none;
  resize:none;
  min-height:44px;
  line-height:1.35;
}

.send{
  border:none;
  background:var(--accent);
  color:#fff;
  border-radius:14px;
  padding:10px 14px;
  cursor:pointer;
  font-size:15px;
  min-width:110px;
}
.send:disabled{opacity:.65; cursor:default;}

.hint{
  font-size:12px;
  color:var(--muted);
  line-height:1.25;
}

/* Thinking dots (no box) */
.thinkingLine{
  font-size:20px;
  line-height:1;
  color:rgba(91,106,120,0.9);
  padding:2px 0 0 2px;
  user-select:none;
}
.thinkingDots{ display:inline-block; width:3ch; }
.thinkingDots::before{
  content:"...";
  animation:pulse 1.1s ease-in-out infinite;
}
.thinkingDots.slow::before{ animation-duration:2s; }
@keyframes pulse{
  0%,100%{opacity:.25;}
  50%{opacity:.95;}
}

/* Copy button */
.copyBtn{
  position:absolute;
  top:6px;
  right:6px;
  border:1px solid rgba(0,0,0,.12);
  background:rgba(255,255,255,.75);
  border-radius:8px;
  padding:4px 6px;
  font-size:11px;
  cursor:pointer;
  opacity:0;
  transition:opacity .2s;
}
.bubble:hover .copyBtn{opacity:.92;}

/* KaTeX blending */
.bubble .katex{ font-size:1.02em; color:inherit; }
.bubble .katex-display{ margin:.45em 0 .35em 0; }
</style>
</head>

<body>
<div class="wrap">

  <div class="chat">

    <!-- Single blue title bar -->
    <div class="titlebar">
      <div class="titleLeft">
        <span>Physikus</span>
        <span class="tag">ðŸ¤“</span>
      </div>

      <div class="titleActions">
        <button id="reset" class="resetBtn" type="button" title="ZurÃ¼cksetzen">
          â†º <span>ZurÃ¼cksetzen</span>
        </button>
      </div>
    </div>

    <!-- Messages -->
    <div id="chatBody" class="chatBody" aria-live="polite"></div>

    <!-- Footer stays visible -->
    <div class="footer">
      <div class="composer">
        <textarea id="q" class="input" placeholder="Frage stellenâ€¦"></textarea>
        <button id="send" class="send" type="button">Senden</button>
      </div>
      <div class="hint">Enter = Senden Â· Shift+Enter = neue Zeile</div>
    </div>

  </div>

</div>

<script>
const WORKER_URL = "https://ai-chat-app.raphaerber.workers.dev/api/chat";

const chatEl  = document.getElementById("chatBody");
const qEl     = document.getElementById("q");
const sendEl  = document.getElementById("send");
const resetEl = document.getElementById("reset");

let messages = [];

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

function renderMath(el){
  if (!window.renderMathInElement) return;
  renderMathInElement(el, {
    delimiters: [
      { left:"$$", right:"$$", display:true },
      { left:"\\[", right:"\\]", display:true },
      { left:"\\(", right:"\\)", display:false },
      { left:"$", right:"$", display:false }
    ],
    throwOnError: false
  });
}

function addMsg(role, who, text){
  const msg = document.createElement("div");
  msg.className = "msg " + (role === "user" ? "me" : "bot");

  const whoEl = document.createElement("div");
  whoEl.className = "who";
  whoEl.textContent = who;

  const bubble = document.createElement("div");
  bubble.className = "bubble";

  const copyBtn = document.createElement("button");
  copyBtn.className = "copyBtn";
  copyBtn.type = "button";
  copyBtn.textContent = "Copy";
  copyBtn.onclick = () => navigator.clipboard?.writeText(text).catch(()=>{});
  bubble.appendChild(copyBtn);

  bubble.innerHTML += escapeHtml(text);

  msg.appendChild(whoEl);
  msg.appendChild(bubble);

  chatEl.appendChild(msg);
  chatEl.scrollTop = chatEl.scrollHeight;

  renderMath(bubble);
}

function addThinkingLine(){
  const div = document.createElement("div");
  div.className = "thinkingLine";
  div.innerHTML = `<span class="thinkingDots"></span>`;
  chatEl.appendChild(div);
  chatEl.scrollTop = chatEl.scrollHeight;
  return div;
}

function boot(){
  messages = [];
  chatEl.innerHTML = "";
  const hello = "Hallo! Ich bin Physikus ðŸ¤“. Welche Frage hast du?";
  addMsg("assistant", "Physikus", hello);
  messages.push({ role:"assistant", content: hello });
  qEl.value = "";
  qEl.focus();
}

async function ask(){
  const text = qEl.value.trim();
  if (!text) return;

  qEl.value = "";
  addMsg("user", "Du", text);
  messages.push({ role:"user", content: text });

  sendEl.disabled = true;

  let thinkingDiv = null;
  const timer = setTimeout(() => {
    thinkingDiv = addThinkingLine();
    const dotsEl = thinkingDiv.querySelector(".thinkingDots");
    setTimeout(() => { if (dotsEl) dotsEl.classList.add("slow"); }, 5000);
  }, 500);

  try{
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ messages: messages.slice(-12) })
    });

    const data = await res.json();
    const reply = data?.reply || "Keine Antwort erhalten.";

    clearTimeout(timer);
    if (thinkingDiv) thinkingDiv.remove();

    addMsg("assistant", "Physikus", reply);
    messages.push({ role:"assistant", content: reply });

  } catch(e){
    clearTimeout(timer);
    if (thinkingDiv) thinkingDiv.remove();

    addMsg("assistant", "Physikus", "Verbindungsfehler.");
    messages.push({ role:"assistant", content: "Verbindungsfehler." });
  } finally{
    sendEl.disabled = false;
    qEl.focus();
  }
}

// Enter = send, Shift+Enter = newline
qEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    ask();
  }
});
sendEl.addEventListener("click", ask);
resetEl.addEventListener("click", boot);

window.addEventListener("load", boot);
</script>
</body>
</html>
