<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Physikus</title>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --ink:#0a2a43;
  --muted:#5b6a78;
  --accent:#2b8cff;
  --bubbleMe:#eef6ff;
  --bubbleBot:#f7fbf7;
  --stroke:rgba(0,0,0,.10);
  --shadow:0 10px 28px rgba(0,0,0,.10);
  --radius:16px;
}

html,body{height:100%;}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--ink);
}

/* ===== Layout ===== */

.wrap{
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* Neue minimalistische Titelzeile */
.titlebar{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  padding:8px 10px;
  background:var(--card);
  border-bottom:1px solid var(--stroke);
}

/* Reset Button oben rechts */
.resetBtn{
  border:1px solid var(--stroke);
  background:#fff;
  border-radius:10px;
  padding:6px 10px;
  cursor:pointer;
  font-size:13px;
  color:var(--muted);
}

.resetBtn:hover{
  background:#f2f6ff;
}

/* ===== Chat Panel ===== */

.panel{
  flex:1;
  display:flex;
  flex-direction:column;
  padding:10px 12px;
  gap:10px;
  min-height:0;
}

.chat{
  flex:1;
  background:var(--card);
  border:1px solid var(--stroke);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:10px;
  overflow:auto;
}

.msg{margin:10px 0;}
.who{
  font-weight:700;
  font-size:11px;
  color:var(--muted);
  margin-bottom:4px;
}

.bubble{
  position:relative;
  display:inline-block;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.06);
  white-space:pre-wrap;
  line-height:1.35;
  font-size:14px;
  max-width:900px;
}

.me .bubble{background:var(--bubbleMe);}
.bot .bubble{background:var(--bubbleBot);}

/* ===== Input ===== */

.composer{
  display:flex;
  gap:10px;
}

textarea.input{
  flex:1;
  background:var(--card);
  border:1px solid var(--stroke);
  border-radius:14px;
  padding:10px 12px;
  font-size:14px;
  outline:none;
  resize:none;
  min-height:44px;
}

.send{
  border:none;
  background:var(--accent);
  color:#fff;
  border-radius:14px;
  padding:10px 14px;
  cursor:pointer;
  font-size:15px;
  min-width:110px;
}

.send:disabled{
  opacity:.65;
  cursor:default;
}

.hint{
  font-size:12px;
  color:var(--muted);
}

/* ===== Thinking dots ===== */

.thinkingLine{
  font-size:20px;
  color:rgba(91,106,120,0.9);
  padding-left:4px;
}

.thinkingDots{
  display:inline-block;
  width:3ch;
}

.thinkingDots::before{
  content:"...";
  animation:pulse 1.1s ease-in-out infinite;
}

.thinkingDots.slow::before{
  animation-duration:2s;
}

@keyframes pulse{
  0%,100%{opacity:.25;}
  50%{opacity:.95;}
}

/* ===== Copy Button ===== */

.copyBtn{
  position:absolute;
  top:6px;
  right:6px;
  border:1px solid rgba(0,0,0,.12);
  background:rgba(255,255,255,.7);
  border-radius:8px;
  padding:4px 6px;
  font-size:11px;
  cursor:pointer;
  opacity:0;
  transition:opacity .2s;
}

.bubble:hover .copyBtn{opacity:.9;}

</style>
</head>

<body>
<div class="wrap">

  <!-- Neue Titelzeile -->
  <div class="titlebar">
    <button id="reset" class="resetBtn">ZurÃ¼cksetzen</button>
  </div>

  <div class="panel">

    <div id="chat" class="chat"></div>

    <div class="composer">
      <textarea id="q" class="input" placeholder="Frage stellenâ€¦"></textarea>
      <button id="send" class="send">Senden</button>
    </div>

    <div class="hint">
      Enter = Senden Â· Shift+Enter = neue Zeile
    </div>

  </div>
</div>

<script>
const WORKER_URL="https://ai-chat-app.raphaerber.workers.dev/api/chat";

const chatEl=document.getElementById("chat");
const qEl=document.getElementById("q");
const sendEl=document.getElementById("send");
const resetEl=document.getElementById("reset");

let messages=[];

/* ===== Helpers ===== */

function escapeHtml(s){
 return String(s).replace(/[&<>"']/g,m=>({
  "&":"&amp;",
  "<":"&lt;",
  ">":"&gt;",
  '"':"&quot;",
  "'":"&#39;"
 }[m]));
}

function renderMath(el){
 if(window.renderMathInElement){
   renderMathInElement(el,{
    delimiters:[
      {left:"$$",right:"$$",display:true},
      {left:"\\(",right:"\\)",display:false},
      {left:"$",right:"$",display:false}
    ],
    throwOnError:false
   });
 }
}

function addMsg(role,who,text){

 const msg=document.createElement("div");
 msg.className="msg "+(role==="user"?"me":"bot");

 const whoEl=document.createElement("div");
 whoEl.className="who";
 whoEl.textContent=who;

 const bubble=document.createElement("div");
 bubble.className="bubble";

 const copyBtn=document.createElement("button");
 copyBtn.className="copyBtn";
 copyBtn.textContent="Copy";
 copyBtn.onclick=()=>navigator.clipboard.writeText(text);

 bubble.appendChild(copyBtn);
 bubble.innerHTML+=escapeHtml(text);

 msg.appendChild(whoEl);
 msg.appendChild(bubble);

 chatEl.appendChild(msg);
 chatEl.scrollTop=chatEl.scrollHeight;

 renderMath(bubble);
}

function addThinking(){
 const d=document.createElement("div");
 d.className="thinkingLine";
 d.innerHTML='<span class="thinkingDots"></span>';
 chatEl.appendChild(d);
 chatEl.scrollTop=chatEl.scrollHeight;
 return d;
}

function boot(){
 messages=[];
 chatEl.innerHTML="";
 const hello="Hallo! Ich bin Physikus ðŸ¤“. Welche Frage hast du?";
 addMsg("assistant","Physikus",hello);
 messages.push({role:"assistant",content:hello});
}

/* ===== Ask ===== */

async function ask(){

 const text=qEl.value.trim();
 if(!text) return;

 qEl.value="";
 addMsg("user","Du",text);
 messages.push({role:"user",content:text});

 sendEl.disabled=true;

 let thinking;
 const timer=setTimeout(()=>{
   thinking=addThinking();
 },500);

 try{

 const res=await fetch(WORKER_URL,{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({messages:messages.slice(-12)})
 });

 const data=await res.json();
 const reply=data?.reply || "Keine Antwort erhalten.";

 clearTimeout(timer);
 if(thinking) thinking.remove();

 addMsg("assistant","Physikus",reply);
 messages.push({role:"assistant",content:reply});

 }catch(e){
 addMsg("assistant","Physikus","Verbindungsfehler.");
 }

 sendEl.disabled=false;
 qEl.focus();
}

/* ===== Events ===== */

sendEl.onclick=ask;

qEl.addEventListener("keydown",e=>{
 if(e.key==="Enter" && !e.shiftKey){
  e.preventDefault();
  ask();
 }
});

resetEl.onclick=boot;

window.onload=boot;

</script>
</body>
</html>
