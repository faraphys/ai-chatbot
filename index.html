<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Physikus</title>

<script>
window.MathJax = {
  tex: {
    inlineMath: [['\\(', '\\)']],
    displayMath: [['$$', '$$']]
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#f4f6fb;
}

.wrap{
  height:100vh;
  display:flex;
  flex-direction:column;
}

.topbar{
  display:flex;
  justify-content:space-between;
  padding:10px 12px;
  background:white;
  border-bottom:1px solid #ddd;
}

.controls{
  display:flex;
  align-items:center;
  gap:8px;
}

.chat{
  flex:1;
  padding:10px;
  overflow:auto;
  background:white;
}

.bubble{
  background:#eef6ff;
  padding:10px;
  border-radius:12px;
  margin:6px 0;
}

textarea{
  width:100%;
  padding:10px;
}
</style>
</head>

<body>

<div class="wrap">

<div class="topbar">
  <b>Physikus</b>

  <div class="controls">
    <span>Nerd-Level</span>

    <select id="nerd">
      <option value="tief">tief</option>
      <option value="mittel" selected>mittel</option>
      <option value="hoch">hoch</option>
    </select>

    <button id="reset">↺ Zurücksetzen</button>
  </div>
</div>

<div id="chat" class="chat"></div>
<textarea id="q" placeholder="Frage stellen…"></textarea>

</div>

<script>

const WORKER_URL="https://ai-chat-app.raphaerber.workers.dev/api/chat";

const chatEl=document.getElementById("chat");
const qEl=document.getElementById("q");
const nerdEl=document.getElementById("nerd");

let messages=[];

// -------- URL Override ----------
function getParam(name){
  return new URLSearchParams(location.search).get(name);
}

const forcedLevel=getParam("level");
const lock=getParam("lock");

if(["tief","mittel","hoch"].includes(forcedLevel)){
  nerdEl.value=forcedLevel;
  localStorage.setItem("physikus_nerdLevel",forcedLevel);
}

if(lock==="1" && forcedLevel){
  nerdEl.disabled=true;
}

// ---------- Persist ----------
const saved=localStorage.getItem("physikus_nerdLevel");
if(saved && !forcedLevel){
  nerdEl.value=saved;
}

nerdEl.addEventListener("change",()=>{
  localStorage.setItem("physikus_nerdLevel",nerdEl.value);
});

function addMsg(text){
  const div=document.createElement("div");
  div.className="bubble";
  div.textContent=text;
  chatEl.appendChild(div);
  MathJax.typesetPromise([div]);
}

async function ask(){
  const text=qEl.value.trim();
  if(!text) return;

  addMsg("Du: "+text);
  messages.push({role:"user",content:text});
  qEl.value="";

  const res=await fetch(WORKER_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      nerdLevel: nerdEl.value,
      messages
    })
  });

  const data=await res.json();
  addMsg("Physikus: "+data.reply);
  messages.push({role:"assistant",content:data.reply});
}

qEl.addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    ask();
  }
});

document.getElementById("reset").onclick=()=>{
  messages=[];
  chatEl.innerHTML="";
};

</script>

</body>
</html>
